rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdminRequest() {
      return request.auth != null && request.auth.token.get('admin', false) == true;
    }
    // Users collection
    match /users/{userId} {
      function isValidProfileFieldLengths() {
        return request.resource.data.displayName is string &&
          request.resource.data.displayName.size() > 0 &&
          request.resource.data.displayName.size() <= 50 &&
          (!('writingContext' in request.resource.data) ||
            (request.resource.data.writingContext is string &&
             request.resource.data.writingContext.size() <= 200)) &&
          (!('displayNameLower' in request.resource.data) ||
            (request.resource.data.displayNameLower is string &&
             request.resource.data.displayNameLower.size() <= 50));
      }

      allow read: if isAdminRequest() || (request.auth != null && request.auth.uid == userId);
      allow create: if isAdminRequest(); // Only backend (Admin SDK/Admin claim) can create users
      allow update: if isAdminRequest() || (request.auth != null && request.auth.uid == userId &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(
          ['photoURL', 'displayName', 'displayNameLower', 'writingContext', 'language', 'useLanguageForBooks', 'updatedAt']
        ) &&
        isValidProfileFieldLengths());

      // Notification projection is server-authoritative (Cloud Functions/Admin SDK only writes)
      match /notifications/{notificationId} {
        allow read: if isAdminRequest() || (request.auth != null && request.auth.uid == userId);
        allow create, update, delete: if false;
      }
    }

    // Payments collection
    match /payments/{paymentId} {
      // Allow the owner (or admin) to read a single payment doc
      allow get: if isAdminRequest() ||
        (request.auth != null && request.auth.uid == resource.data.userId);

      // Do not allow listing payments from the client
      allow list: if false;

      // Keep writes server-only (Cloud Functions uses Admin SDK; rules don't apply)
      allow create, update, delete: if isAdminRequest();
    }

    // Books collection with public/private and co-author support
    match /books/{bookId} {
      // Helper function to get book data
      function bookData() {
        return get(/databases/$(database)/documents/books/$(bookId)).data;
      }

      // Helper function to check if user is owner
      function isOwner() {
        return request.auth != null && bookData().ownerId == request.auth.uid;
      }

      // Helper function to check if user is co-author
      function isCoAuthor() {
        return request.auth != null && bookData().members != null && 
               bookData().members[request.auth.uid] == "Co-author";
      }

      // Helper function to check if user has access
      function hasAccess() {
        return isOwner() || isCoAuthor() || 
               (bookData().isPublic == true && request.auth != null);
      }

      // Read access: owner, co-authors, or public books
      allow read: if isAdminRequest() || (request.auth != null && hasAccess());

      // Create access: authenticated users (book creation)
      allow create: if isAdminRequest() || request.auth != null;

      // Update access:
      // - Owner: full access
      // - Co-author: can update pages/chapters but not isPublic, members, or delete chapters
      allow update: if isAdminRequest() || (request.auth != null && (
        (isOwner() &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['members', 'memberPermissions', 'ownerId'])) ||
        (isCoAuthor() && 
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isPublic', 'members', 'memberPermissions', 'ownerId']) &&
         request.resource.data.isPublic == resource.data.isPublic &&
         request.resource.data.members == resource.data.members &&
         request.resource.data.memberPermissions == resource.data.memberPermissions &&
         request.resource.data.ownerId == resource.data.ownerId)
      ));

      // Delete access: only owner
      allow delete: if isAdminRequest() || (request.auth != null && isOwner());

      // Chapters subcollection
      match /chapters/{chapterId} {
        allow read: if isAdminRequest() || (request.auth != null && hasAccess());
        allow create: if isAdminRequest() || (request.auth != null && (isOwner() || isCoAuthor()));
        allow update: if isAdminRequest() || (request.auth != null && (isOwner() || isCoAuthor()));
        allow delete: if isAdminRequest() || (request.auth != null && isOwner()); // Only owner can delete chapters

        // Pages subcollection
        match /pages/{pageId} {
          allow read: if isAdminRequest() || (request.auth != null && hasAccess());
          allow create: if isAdminRequest() || (request.auth != null && (isOwner() || isCoAuthor()));
          allow update: if isAdminRequest() || (request.auth != null && (isOwner() || isCoAuthor()));
          allow delete: if isAdminRequest() || (request.auth != null && (isOwner() || isCoAuthor()));
        }
      }
    }

    // Invites collection
    match /invites/{inviteId} {
      function isOwnerOrInvitee() {
        return request.auth != null && (
          resource.data.ownerId == request.auth.uid ||
          resource.data.inviteeUid == request.auth.uid
        );
      }

      allow read: if isAdminRequest() || isOwnerOrInvitee();
      allow create, update, delete: if false;
    }

    // Albums collection - single document per album (no subcollections)
    match /albums/{albumId} {
      // Helper function to check album access
      function hasAlbumAccess() {
        return request.auth != null && (
          resource.data.accessPermission.ownerId == request.auth.uid ||
          resource.data.accessPermission.accessType == "public" ||
          (resource.data.accessPermission.accessType == "shared" &&
           request.auth.uid in resource.data.accessPermission.sharedWith)
        );
      }

      allow read: if isAdminRequest() || (request.auth != null && hasAlbumAccess());

      // Album creation must go through backend callables for quota enforcement.
      allow create: if isAdminRequest();

      allow update: if isAdminRequest() || (request.auth != null &&
        resource.data.accessPermission.ownerId == request.auth.uid &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['accessPermission']));

      allow delete: if isAdminRequest() || (request.auth != null &&
        resource.data.accessPermission.ownerId == request.auth.uid);
    }
  }
}
